<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Test - TastyWorld API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { padding: 10px 15px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîç CORS Test - TastyWorld API</h1>

    <div class="test">
        <h3>1. –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</h3>
        <button onclick="testConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        <div id="connection-result"></div>
    </div>

    <div class="test">
        <h3>2. –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
        <input type="text" id="testToken" value="dd2813e334817761450af98ac20fe90b" style="width: 300px; padding: 5px;">
        <button onclick="testAuth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        <div id="auth-result"></div>
    </div>

    <div class="test">
        <h3>3. –¢–µ—Å—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö endpoints</h3>
        <button onclick="testEndpoints()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å endpoints</button>
        <div id="endpoints-result"></div>
    </div>

    <script>
        const baseUrl = 'http://tastyworld-pos.ru:1212/api/v1';
        let currentToken = 'dd2813e334817761450af98ac20fe90b';

        async function testConnection() {
            const result = document.getElementById('connection-result');
            result.innerHTML = 'üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';

            try {
                // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π HEAD –∑–∞–ø—Ä–æ—Å
                const response = await fetch(baseUrl.replace('/api/v1', ''), {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                result.innerHTML = '<div class="success">‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω (no-cors mode)</div>';
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;
            }
        }

        async function testAuth() {
            const token = document.getElementById('testToken').value;
            const result = document.getElementById('auth-result');
            result.innerHTML = 'üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω...';

            try {
                const response = await fetch(`${baseUrl}/authorization_tokens/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    result.innerHTML = `
                        <div class="success">
                            ‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω!<br>
                            –ò–º—è: ${data.name}<br>
                            –ê–∫—Ç–∏–≤–µ–Ω: ${data.is_active}<br>
                            –ú–æ–¥—É–ª–∏: ${data.access_modules.join(', ')}
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${data.detail || response.status}</div>`;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        ‚ùå CORS –æ—à–∏–±–∫–∞ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω<br>
                        –û—à–∏–±–∫–∞: ${error.message}<br>
                        <small>–≠—Ç–æ —Ç–∏–ø–∏—á–Ω–∞—è CORS –æ—à–∏–±–∫–∞. –°–µ—Ä–≤–µ—Ä –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å —ç—Ç–æ–≥–æ –¥–æ–º–µ–Ω–∞.</small>
                    </div>
                `;
            }
        }

        async function testEndpoints() {
            const token = document.getElementById('testToken').value;
            const result = document.getElementById('endpoints-result');
            result.innerHTML = 'üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º endpoints...';

            const endpoints = [
                '/client_points/me',
                '/client_points/me/subscription_days',
                '/menu/products',
                '/menu/categories'
            ];

            let results = '';

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${baseUrl}${endpoint}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        results += `<div class="success">‚úÖ ${endpoint} - –£–°–ü–ï–• (${response.status})</div>`;
                    } else {
                        results += `<div class="error">‚ùå ${endpoint} - –û–®–ò–ë–ö–ê (${response.status})</div>`;
                    }
                } catch (error) {
                    results += `<div class="error">‚ùå ${endpoint} - CORS –û–®–ò–ë–ö–ê: ${error.message}</div>`;
                }
            }

            result.innerHTML = results;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã
        setTimeout(() => {
            testConnection();
            setTimeout(testAuth, 1000);
        }, 500);
    </script>
</body>
</html>